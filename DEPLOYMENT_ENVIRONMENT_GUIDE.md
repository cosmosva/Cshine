# 📦 小程序部署与环境配置指南

## 🎯 核心问题解答

### Q: 推送到线上后，小程序会自动连接线上服务器吗？

**A: 是的！现在已经配置为自动检测环境。**

---

## 🌍 自动环境检测机制

### 工作原理

系统通过微信小程序 API `wx.getAccountInfoSync()` 自动检测当前运行环境：

```javascript
function getEnvironment() {
  const accountInfo = wx.getAccountInfoSync()
  const envVersion = accountInfo.miniProgram.envVersion
  
  if (envVersion === 'release') {
    return 'production'  // 正式版 → 生产环境
  } else {
    return 'development'  // 其他 → 开发环境
  }
}
```

### 环境映射表

| 运行场景 | envVersion | 使用环境 | API 地址 |
|---------|-----------|---------|----------|
| 微信开发者工具 | `undefined` | development | `http://192.168.80.50:8000` |
| 真机调试/预览 | `'develop'` | development | `http://192.168.80.50:8000` |
| 体验版 | `'trial'` | development | `http://192.168.80.50:8000` |
| **正式版** | **`'release'`** | **production** | **`https://cshine.xuyucloud.com`** |

### 优势

✅ **无需手动切换环境**
- 开发时自动用测试服务器
- 发布后自动用生产服务器

✅ **避免人为错误**
- 不会忘记改配置
- 不会污染生产数据

✅ **多环境隔离**
- 开发、体验、正式版数据完全隔离
- 测试更安全

---

## 🚀 完整部署流程

### 1. 本地开发阶段

**你当前所在的阶段**

```bash
# 1. 启动本地后端
cd backend
python main.py

# 2. 打开微信开发者工具
# 3. 实时预览和调试

# 此时自动连接：http://192.168.80.50:8000
```

**查看当前环境：**
打开开发者工具的控制台，会看到：
```
🌍 当前运行环境: development
🔗 API 地址: http://192.168.80.50:8000
```

---

### 2. 上传代码到微信平台

#### 步骤 1：在开发者工具中上传

```
微信开发者工具
  → 右上角"上传"按钮
  → 填写版本号（如 0.4.1）和项目备注
  → 点击"上传"
```

#### 步骤 2：登录微信公众平台

```
访问：https://mp.weixin.qq.com
  → 登录你的小程序账号
  → 左侧菜单："管理" → "版本管理"
```

---

### 3. 提交审核

#### 在微信公众平台操作

```
版本管理页面
  → 找到刚上传的"开发版本"
  → 点击"提交审核"
  → 填写审核信息：
      - 功能页面：选择主要功能页面
      - 测试账号：如需要，提供测试账号
      - 补充说明：简要说明功能
  → 提交
```

**审核时间：** 通常 1-7 个工作日

**此阶段环境：** 开发版和体验版仍连接 `development` 环境

---

### 4. 审核通过后发布

#### 发布到正式版

```
版本管理页面
  → 审核通过后，会出现"审核版本"
  → 点击"发布"
  → 确认发布
```

**🎉 此时，正式版小程序会自动连接生产服务器！**

```
正式版用户看到的：
🌍 当前运行环境: production
🔗 API 地址: https://cshine.xuyucloud.com
```

---

## 📊 版本生命周期

### 完整流程图

```
┌─────────────┐
│ 本地开发    │ → development 环境
│ (开发工具)  │    http://192.168.80.50:8000
└──────┬──────┘
       │ 上传
       ▼
┌─────────────┐
│ 开发版      │ → development 环境
│ (微信平台)  │    http://192.168.80.50:8000
└──────┬──────┘
       │ 
       ├─→ 生成体验版（给内部测试） → development 环境
       │
       │ 提交审核
       ▼
┌─────────────┐
│ 审核中      │ → (无法访问)
└──────┬──────┘
       │ 审核通过
       ▼
┌─────────────┐
│ 正式版      │ → production 环境 ✨
│ (用户使用)  │    https://cshine.xuyucloud.com
└─────────────┘
```

---

## 🧪 测试不同环境

### 1. 测试开发环境

**方式 A：开发工具**
```bash
# 启动本地后端
cd backend
python main.py

# 在开发工具中调试
# 会自动连接 http://192.168.80.50:8000
```

**方式 B：真机预览**
```
开发工具 → 右上角"预览"
       → 手机微信扫码
       → 仍然连接 development 环境
```

---

### 2. 测试体验版

**用途：** 给团队成员或特定用户内测

```
微信公众平台
  → 版本管理
  → 开发版本 → "选为体验版"
  → 成员管理 → 添加体验成员
  → 体验成员扫码进入
```

**环境：** development（安全，不影响生产数据）

---

### 3. 测试正式版

**⚠️ 注意：** 正式版会连接生产服务器！

**建议：**
- 发布前在体验版充分测试
- 正式版发布后，用小号测试关键功能
- 准备回滚方案（微信支持版本回退）

---

## 🔧 手动覆盖环境（特殊场景）

### 场景：开发时临时测试生产环境

如果你想在开发工具中强制使用生产环境：

```javascript
// utils/config.js 临时修改
function getEnvironment() {
  // 临时强制使用生产环境
  return 'production'  // ⚠️ 测试完记得改回来！
  
  // 原来的自动检测代码
  // const accountInfo = wx.getAccountInfoSync()
  // ...
}
```

**⚠️ 记得测试完改回去！**

---

## 📱 用户端体验

### 用户看到的

**正式版小程序：**
```
用户打开小程序
  → 自动连接 https://cshine.xuyucloud.com
  → 所有数据存储在生产数据库
  → 用户无感知，体验流畅
```

**用户不需要：**
- ❌ 手动选择环境
- ❌ 配置服务器地址
- ❌ 知道任何技术细节

**完全透明！** ✨

---

## 🛡️ 安全最佳实践

### 1. 数据隔离

```
开发数据库：backend/cshine.db（本地）
生产数据库：cshine.xuyucloud.com（线上）

✅ 完全隔离，互不影响
```

### 2. 环境验证

每次启动时，检查控制台输出：
```javascript
console.log('🌍 当前运行环境:', ENV)
console.log('🔗 API 地址:', API_BASE_URL)
```

确保符合预期！

### 3. 日志监控

建议在生产环境添加日志：
```javascript
// app.js onLaunch
console.log('小程序启动')
console.log('环境:', ENV)
console.log('版本:', wx.getAccountInfoSync().miniProgram.version)
```

---

## 🚨 常见问题排查

### Q1: 正式版用户反馈无法登录

**可能原因：**
1. 生产服务器未启动
2. 域名配置问题
3. HTTPS 证书过期

**排查步骤：**
```bash
# 1. 检查服务器状态
ssh user@your-server
systemctl status cshine

# 2. 检查域名解析
ping cshine.xuyucloud.com

# 3. 检查 HTTPS
curl https://cshine.xuyucloud.com/api/v1/auth/login
```

---

### Q2: 开发版本可以用，正式版不行

**原因：** 两者连接的是不同服务器

**解决：**
1. 确认生产服务器已部署最新代码
2. 检查生产环境的微信 AppID 和 Secret
3. 确认生产数据库已迁移

---

### Q3: 想回滚到上一个版本

**微信支持版本回退：**
```
微信公众平台
  → 版本管理
  → 线上版本 → "版本回退"
  → 选择要回退的版本
  → 确认
```

**⚠️ 注意：** 
- 只能回退到上一个版本
- 回退不影响代码，但数据库可能需要手动处理

---

## 📋 发布前检查清单

### 代码检查
- [ ] 所有功能在体验版测试通过
- [ ] 没有 console.error 或明显 bug
- [ ] 已更新 CHANGELOG.md
- [ ] 版本号正确递增

### 服务器检查
- [ ] 生产服务器已部署最新代码
- [ ] 生产数据库已备份
- [ ] HTTPS 证书有效
- [ ] 微信 AppID/Secret 配置正确

### 配置检查
- [ ] `utils/config.js` 使用自动检测环境
- [ ] `project.config.json` appid 正确
- [ ] 后端 `config.py` 生产环境配置正确

### 微信平台检查
- [ ] 服务器域名已配置到"开发设置"
- [ ] request 合法域名已添加
- [ ] uploadFile 合法域名已添加（如需要）

---

## 🎓 总结

### 核心要点

1. **✅ 自动环境检测**
   - 开发时自动用测试环境
   - 正式版自动用生产环境
   - 无需手动干预

2. **✅ 多环境隔离**
   - 开发、体验、正式版数据完全隔离
   - 安全可靠

3. **✅ 发布即生效**
   - 代码上传 → 审核 → 发布
   - 自动切换到生产环境
   - 用户无感知

4. **✅ 灵活可控**
   - 支持体验版内测
   - 支持版本回退
   - 支持手动覆盖（特殊场景）

### 你现在的状态

```
✅ 代码已配置自动环境检测
✅ 本地开发环境正常
✅ 生产服务器已部署
✅ 微信 AppID 已配置

👉 下一步：充分测试后，随时可以上传审核发布！
```

---

## 🚀 快速发布命令

```bash
# 1. 最后一次测试
# 2. 提交代码
git add .
git commit -m "feat: 完善个人页面，准备发布 v0.4.1"
git push

# 3. 打开微信开发者工具
# 4. 点击"上传"
# 5. 等待审核
# 6. 审核通过后点击"发布"

# 🎉 发布成功！用户会自动连接生产环境
```

有任何问题随时问我！🚀

