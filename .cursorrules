# 🤖 AI 助手开发规则

> **重要**：这是给 AI 助手（Claude、GPT等）看的规则文件  
> 每次帮用户开发新功能时必须遵循这些规则

---

## ⚡ 核心规则（必须遵守）

### 规则 1：版本号自动管理

**版本号格式**：`主版本.次版本.修订号`（例如：`0.5.9`）

**AI 助手的职责**：
- ✅ **每次 git commit 时自动递增修订号**
  - 当前版本：`0.5.9` → 下次提交：`0.5.10`
  - 当前版本：`0.5.10` → 下次提交：`0.5.11`
  - 以此类推...

- ❌ **不能自动升级次版本或主版本**
  - `0.5.x` → `0.6.0` 需要用户明确指示
  - `0.x.x` → `1.0.0` 需要用户明确指示

**执行步骤**：
1. 提交代码前，检查当前版本号
2. 自动递增修订号（最后一位 +1）
3. 更新 `docs/core/CHANGELOG.md` 中的版本号
4. 在 commit message 中包含新版本号
5. 创建对应的 git tag（如果是重要更新）

**示例**：
```bash
# 当前版本：v0.5.9
git commit -m "fix: 修复 Modal 显示问题 (v0.5.10)"
git tag v0.5.10

# 下次提交
git commit -m "feat: 新增功能 (v0.5.11)"
git tag v0.5.11
```

---

### 规则 2：资源文件复用优先

**图标使用规则**：
- ✅ **优先使用现有图标**
  - 使用前先检查 `assets/icons/` 目录
  - 复用已有图标，避免重复创建
  
- ❌ **不要创建不存在的图标**
  - 不要在代码中引用不存在的图标路径
  - 不要假设某个图标存在

**现有图标清单**：
```
assets/icons/
├── folder.png          # 📁 文件夹图标（知识库、目录）
├── add-folder.png      # ➕ 新建文件夹
├── add.png             # ➕ 添加
├── flash-active.png    # ⚡ 闪记（激活）
├── flash.png           # ⚡ 闪记（未激活）
├── knowledge-active.png # 📚 知识库（激活）
├── knowledge.png       # 📚 知识库（未激活）
├── profile-active.png  # 👤 个人（激活）
├── profile.png         # 👤 个人（未激活）
├── search.png          # 🔍 搜索
├── sort.png            # 🔄 排序
├── menu.png            # ☰ 菜单
├── copy.png            # 📋 复制
├── delete.png          # 🗑️ 删除
├── move.png            # 📦 移动
├── rename.png          # ✏️ 重命名
└── upfile.png          # 📤 上传
```

**使用示例**：
```javascript
// ✅ 正确：使用现有图标
<image src="/assets/icons/folder.png" />

// ❌ 错误：引用不存在的图标
<image src="/assets/icons/folder-open.png" />  // 这个文件不存在！
```

---

### 规则 3：后端功能更新必须创建部署文档

**触发条件**（满足任一即需要）：
- ✅ 修改/新增后端 API 接口
- ✅ 修改数据库结构（新增表、字段、索引等）
- ✅ 修改/新增环境变量配置
- ✅ 新增/更新 Python 依赖（requirements.txt）
- ✅ 修复后端 Bug
- ✅ 后端性能优化
- ✅ 后端代码重构（影响部署）

**不需要创建部署文档**：
- ❌ 仅修改前端代码（小程序页面、样式、组件）
- ❌ 仅修改文档
- ❌ 仅修改注释
- ❌ 前端 Bug 修复（不涉及后端）

---

### 规则 4：线上部署关键检查（必须遵守）

**每次涉及线上部署时，必须检查以下事项：**

#### 4.1 代码推送检查
- ✅ **本地提交后必须推送到远程仓库**
  ```bash
  git commit -m "xxx"
  git push origin main  # 不要忘记这一步！
  ```
- ✅ **在 GitHub 上确认最新提交可见**

#### 4.2 服务器环境适配
- ✅ **Python 命令使用 `python3.11`**（不是 `python` 或 `python3`）
- ✅ **虚拟环境路径：`/home/cshine/Cshine/venv`**（项目根目录，不在 backend 下）
- ✅ **数据库配置使用 `DATABASE_URL`**（不是 DB_HOST 等独立字段）

#### 4.3 数据库迁移脚本
- ✅ **从 `DATABASE_URL` 解析连接信息**
  ```python
  from urllib.parse import urlparse
  db_url = urlparse(settings.DATABASE_URL)
  conn = psycopg2.connect(
      host=db_url.hostname,
      port=db_url.port or 5432,
      database=db_url.path.lstrip('/'),
      user=db_url.username,
      password=db_url.password
  )
  ```
- ✅ **初始化 `conn = None` 和 `cursor = None`**（避免 UnboundLocalError）

#### 4.4 小程序配置检查
- ✅ **生产环境必须使用 HTTPS 域名**
  ```javascript
  // ❌ 错误
  production: 'http://8.134.254.88:8000'
  
  // ✅ 正确
  production: 'https://cshine.xuyucloud.com'
  ```

#### 4.5 部署流程检查
1. 本地代码已提交并推送
2. 服务器拉取最新代码
3. 执行数据库迁移（如有）
4. 重启服务
5. 验证服务状态
6. 验证健康检查
7. 小程序重新上传（如有前端改动）

#### 4.6 验证命令
```bash
# 服务器端验证
curl http://localhost:8000/health
curl https://cshine.xuyucloud.com/health
sudo systemctl status cshine-api

# 查看日志
sudo journalctl -u cshine-api -n 50
```

**详细经验文档**：`docs/deployment/LESSONS_LEARNED.md`

---

## 📝 创建部署文档的标准流程

### 步骤 1：完成功能开发和测试

正常开发代码...

### 步骤 2：创建部署文档（必须）

```bash
# 使用模板创建文档
cp .github_docs_template.md docs/features/DEPLOY_<功能名>_$(date +%Y%m%d).md
```

**文档命名规范**：
```
DEPLOY_<功能名>_<日期>.md

示例：
DEPLOY_MEETING_FEATURE_20251109.md  # 会议功能
DEPLOY_AUTH_FIX_20251109.md         # 认证修复
DEPLOY_PERFORMANCE_20251110.md      # 性能优化
```

### 步骤 3：填写完整信息（必须）

使用 `.github_docs_template.md` 模板，必须填写：

1. **更新类型**：新功能/Bug修复/性能优化/安全补丁
2. **是否必须**：必须🔴/建议🟡/可选🟢
3. **预计停机时间**：无/<5分钟/<15分钟
4. **涉及文件**：列出所有修改的文件及改动说明
5. **数据库变更**：是否有新增表、字段、迁移脚本
6. **依赖变更**：是否有新增 Python 包
7. **环境变量变更**：是否需要修改 .env
8. **部署步骤**：
   - 方式1：自动脚本（推荐 `bash docs/deployment/UPDATE_SERVER.sh`）
   - 方式2：手动步骤
9. **验证方法**：如何验证更新成功
10. **回滚方案**：出问题如何快速回滚

### 步骤 4：与代码一起提交

```bash
git add .
git commit -m "feat: 新功能 + 线上部署方案

- 实现了 xxx 功能
- 新增了 xxx 接口

部署文档：docs/features/DEPLOY_XXX_20251109.md
更新优先级：建议🟡"

git push origin main
```

---

## 🎯 更新优先级判断

| 优先级 | 标识 | 情况 | 示例 |
|-------|------|------|------|
| **必须** | 🔴 | 安全漏洞、严重Bug、数据丢失 | 登录认证失败、数据库错误 |
| **建议** | 🟡 | 新功能、性能优化、体验改进 | 会议功能、查询优化 |
| **可选** | 🟢 | 代码重构、日志优化、注释 | 代码整理、日志完善 |

---

## 📋 AI 助手执行检查清单

### 在完成代码后，自动执行：

```
[ ] 检查是否修改了后端代码
    └─ 是 → 继续
    └─ 否 → 跳过部署文档
    
[ ] 检查更新类型
    └─ 新功能/Bug修复/优化/重构
    
[ ] 创建部署文档
    └─ 位置：docs/features/DEPLOY_<功能名>_<日期>.md
    └─ 使用模板：.github_docs_template.md
    
[ ] 填写完整信息
    └─ 更新类型 ✓
    └─ 优先级（必须🔴/建议🟡/可选🟢）✓
    └─ 涉及文件 ✓
    └─ 数据库变更 ✓
    └─ 依赖变更 ✓
    └─ 环境变量变更 ✓
    └─ 部署步骤 ✓
    └─ 验证方法 ✓
    └─ 回滚方案 ✓
    
[ ] 更新 CHANGELOG
    └─ 位置：docs/core/CHANGELOG.md
    └─ 新增版本号和更新说明
    
[ ] 在 commit message 中提到部署文档
    └─ 格式：feat: xxx + 线上部署方案
    └─ 包含：部署文档路径
    └─ 包含：更新优先级
    
[ ] 提醒用户
    └─ "已创建部署文档：docs/features/DEPLOY_xxx.md"
    └─ "更新优先级：建议🟡"
    └─ "详见部署文档中的部署步骤和验证方法"
```

---

## 💬 与用户沟通的标准话术

### 完成功能后，必须说：

```
✅ 功能开发完成！

📋 已创建线上部署文档：
   docs/features/DEPLOY_<功能名>_YYYYMMDD.md

🎯 更新优先级：[必须🔴 / 建议🟡 / 可选🟢]

📝 部署摘要：
   - 更新类型：[新功能/Bug修复/优化]
   - 数据库变更：[是/否]
   - 依赖变更：[是/否]
   - 环境变量变更：[是/否]
   - 推荐部署方式：bash docs/deployment/UPDATE_SERVER.sh
   - 预计停机时间：[无/<5分钟]

详细的部署步骤、验证方法和回滚方案请查看部署文档。
```

---

## 📖 示例：会议功能开发

### 错误示例（不要这样）❌

```
完成了会议功能的开发，包括：
- 新增了会议上传接口
- 修改了数据库结构
- 更新了 AI 处理逻辑

代码已提交，可以测试了。
```

**问题**：
- ❌ 没有创建部署文档
- ❌ 没有说明如何部署到线上
- ❌ 没有提供验证方法
- ❌ 没有回滚方案

---

### 正确示例（要这样）✅

```
✅ 会议纪要功能开发完成！

📋 已创建线上部署文档：
   docs/features/DEPLOY_MEETING_FEATURE_20251109.md

🎯 更新优先级：建议🟡

📝 部署摘要：
   - 更新类型：新功能
   - 数据库变更：是（新增 meetings 表）
   - 依赖变更：否
   - 环境变量变更：否
   - 推荐部署方式：bash docs/deployment/UPDATE_SERVER.sh
   - 预计停机时间：无

详细的部署步骤、验证方法和回滚方案请查看部署文档。

代码已提交，本地测试通过。线上部署时按照部署文档执行即可。
```

**优点**：
- ✅ 创建了部署文档
- ✅ 明确了更新优先级
- ✅ 说明了关键变更点
- ✅ 提供了部署方式
- ✅ 指向了详细文档

---

## 🔍 常见场景判断

### 场景 1：新增后端 API

```
代码：backend/app/api/meeting.py
判断：✅ 需要创建部署文档
原因：新增了后端功能
```

### 场景 2：修复后端 Bug

```
代码：backend/app/api/auth.py（修复认证错误）
判断：✅ 需要创建部署文档
优先级：🔴 必须（严重Bug）
原因：影响线上功能，需要紧急部署
```

### 场景 3：数据库结构变更

```
代码：backend/app/models.py（新增字段）
判断：✅ 需要创建部署文档
原因：需要数据库迁移
特别注意：必须提供迁移脚本和回滚方案
```

### 场景 4：前端页面调整

```
代码：pages/meeting/list.wxml（修改样式）
判断：❌ 不需要创建部署文档
原因：仅前端修改，小程序重新发布即可
```

### 场景 5：文档更新

```
代码：docs/core/README.md
判断：❌ 不需要创建部署文档
原因：仅文档修改
```

---

## 🎓 AI 助手的职责

作为 AI 助手，你需要：

1. **主动检查**：完成代码后，主动判断是否需要创建部署文档
2. **自动创建**：如果需要，自动创建部署文档并填写完整信息
3. **清晰沟通**：告诉用户已创建部署文档，说明部署要点
4. **提供帮助**：解答用户关于部署的疑问
5. **持续改进**：根据实际使用情况，建议优化流程

---

## 📚 相关文档快速链接

- [部署文档模板](../.github_docs_template.md)
- [后端更新协议](docs/deployment/BACKEND_UPDATE_PROTOCOL.md)
- [开发规范](docs/core/DEVELOPMENT_GUIDE.md)
- [文档结构说明](docs/README.md)

---

## ⚠️ 特别提醒

**每次帮用户开发后端功能时，完成代码后：**

1. 🔍 **自动判断**：是否修改了后端
2. 📝 **立即创建**：部署文档（使用模板）
3. ✍️ **填写完整**：所有必填项
4. 📢 **明确告知**：已创建，位置在哪，如何部署
5. 🎯 **标注优先级**：让用户知道重要程度

**不要让用户提醒你创建部署文档，要主动完成！**

---

## 🎯 快速记忆

```
后端功能更新 = 必须创建部署文档

位置：docs/features/DEPLOY_xxx_YYYYMMDD.md
模板：.github_docs_template.md
优先级：必须🔴 / 建议🟡 / 可选🟢

完成后告知用户：
- 已创建部署文档
- 文档位置
- 更新优先级
- 关键变更点
```

---

**记住**：这是为了确保每次功能更新都有清晰的线上部署方案，降低部署风险！

---

**版本**: v1.0  
**更新日期**: 2025-11-09  
**适用对象**: AI 助手（Claude、GPT等）

---

**Let Your Ideas Shine. ✨**

