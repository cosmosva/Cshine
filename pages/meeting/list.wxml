<!--ä¼šè®®çºªè¦åˆ—è¡¨é¡µ - çŸ¥è¯†åº“ v2-->
<wxs module="utils" src="./list.wxs"></wxs>
<view class="meeting-list-page">
  <!-- å“ç‰Œæ ï¼ˆç¬¬ä¸€å±‚å¯¼èˆªï¼‰ -->
  <view class="brand-bar">
    <view class="brand-left">
      <view class="logo-circle">C</view>
      <text class="brand-name">Cshine</text>
      <view class="record-btn" bindtap="goToRecord">
        <text class="record-icon">â—</text>
        <text class="record-text">å½•éŸ³</text>
      </view>
    </view>
    <view class="brand-right">
    </view>
  </view>

  <!-- äºŒçº§å¯¼èˆªæ  -->
  <view class="header">
    <view class="header-left">
      <image class="menu-icon" src="/assets/icons/menu.png" mode="aspectFit" bindtap="toggleDrawer"></image>
      <text class="title">å½•éŸ³æ–‡ä»¶</text>
    </view>
    <view class="header-right">
      <image class="icon-btn search-icon" src="/assets/icons/search.png" mode="aspectFit"></image>
      <image class="icon-btn add-icon" src="/assets/icons/add.png" mode="aspectFit" bindtap="showUploadMenu"></image>
      <view class="sort-btn" bindtap="showSortMenu">
        <text class="icon">â‡…</text>
      </view>
    </view>
  </view>

  <!-- ä¸»å†…å®¹åŒº -->
  <view class="page-content">
    <!-- ä¼šè®®åˆ—è¡¨ -->
    <scroll-view 
      class="meeting-scroll"
      scroll-y
      enhanced
      show-scrollbar="{{false}}"
      enable-back-to-top
      refresher-enabled
      refresher-triggered="{{refreshing}}"
      bindrefresherrefresh="onPullDownRefresh"
      bindscrolltolower="onReachBottom"
    >
      <view class="meeting-list">
        <view 
          class="meeting-card"
          wx:for="{{meetingList}}"
          wx:key="id"
          bindtap="viewMeeting"
          data-id="{{item.id}}"
          data-status="{{item.status}}"
        >
          <!-- ç¬¬ä¸€è¡Œï¼šæ ‡é¢˜ + æ”¶è— -->
          <view class="card-row-1">
            <text class="title">{{item.title}}</text>
            <view class="star-btn" catchtap="toggleFavorite" data-id="{{item.id}}" data-favorite="{{item.is_favorite}}">
              <text class="star-icon">{{item.is_favorite ? 'â­' : 'â˜†'}}</text>
            </view>
          </view>

          <!-- ç¬¬äºŒè¡Œï¼šå½•éŸ³æ—¶é—´ + å½•éŸ³æ—¶é•¿ -->
          <view class="card-row-2">
            <text class="timestamp">{{utils.formatFullTime(item.created_at)}}</text>
            <text class="duration" wx:if="{{item.audio_duration}}">{{utils.formatDuration(item.audio_duration)}}</text>
          </view>

          <!-- ç¬¬ä¸‰è¡Œï¼šæ‰¬å£°å™¨å›¾æ ‡ + æ ‡ç­¾ -->
          <view class="card-row-3">
            <text class="audio-icon">ğŸ”Š</text>
            <text class="source-label">æ‰¬å£°å™¨</text>
            <view class="tags-container" wx:if="{{item.tags && item.tags.length > 0}}">
              <text class="tag" wx:for="{{item.tags}}" wx:key="index" wx:for-item="tag">{{tag}}</text>
            </view>
          </view>
        </view>

        <!-- ç©ºçŠ¶æ€ -->
        <view class="empty-state" wx:if="{{meetingList.length === 0 && !loading}}">
          <text class="empty-icon">ğŸ“‹</text>
          <text class="empty-text">{{emptyText}}</text>
          <text class="empty-hint">ç‚¹å‡»å³ä¸Šè§’ä¸Šä¼ ä¼šè®®éŸ³é¢‘å¼€å§‹</text>
        </view>

        <!-- åŠ è½½æç¤º -->
        <view class="load-more" wx:if="{{loading && meetingList.length > 0}}">
          <text class="loading-text">åŠ è½½ä¸­...</text>
        </view>

        <view class="load-more" wx:if="{{!loading && !hasMore && meetingList.length > 0}}">
          <text class="no-more-text">æ²¡æœ‰æ›´å¤šäº†</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- ç­›é€‰èœå•ï¼ˆActionSheetï¼‰ -->
  <view class="action-sheet-mask" wx:if="{{showFilterSheet}}" bindtap="hideFilterSheet" catchtouchmove="preventDefault"></view>
  <view class="action-sheet {{showFilterSheet ? 'show' : ''}}">
    <view class="action-sheet-header">
      <text class="action-sheet-title">ç­›é€‰</text>
      <view class="action-sheet-close" bindtap="hideFilterSheet">âœ•</view>
    </view>
    <view class="action-sheet-body">
      <view 
        class="action-item {{currentFilter === item.value ? 'active' : ''}}"
        wx:for="{{filterOptions}}"
        wx:key="value"
        bindtap="selectFilter"
        data-value="{{item.value}}"
        data-label="{{item.label}}"
      >
        <text class="action-label">{{item.label}}</text>
        <text class="action-check" wx:if="{{currentFilter === item.value}}">âœ“</text>
      </view>
    </view>
  </view>

  <!-- æ’åºèœå•ï¼ˆActionSheetï¼‰ -->
  <view class="action-sheet-mask" wx:if="{{showSortSheet}}" bindtap="hideSortSheet" catchtouchmove="preventDefault"></view>
  <view class="action-sheet {{showSortSheet ? 'show' : ''}}">
    <view class="action-sheet-header">
      <text class="action-sheet-title">æ’åº</text>
      <view class="action-sheet-close" bindtap="hideSortSheet">âœ•</view>
    </view>
    <view class="action-sheet-body">
      <view 
        class="action-item {{currentSort === item.value ? 'active' : ''}}"
        wx:for="{{sortOptions}}"
        wx:key="value"
        bindtap="selectSort"
        data-value="{{item.value}}"
      >
        <text class="action-label">{{item.label}}</text>
        <text class="action-check" wx:if="{{currentSort === item.value}}">âœ“</text>
      </view>
    </view>
  </view>

  <!-- ä¾§è¾¹æ æŠ½å±‰ - çŸ¥è¯†åº“ç®¡ç† -->
  <view class="drawer-mask {{showDrawer ? 'show' : ''}}" bindtap="closeDrawer" catchtouchmove="preventDefault"></view>
  <view class="drawer {{showDrawer ? 'show' : ''}}">
    <!-- æŠ½å±‰å¤´éƒ¨ -->
    <view class="drawer-header">
      <text class="drawer-title">çŸ¥è¯†åº“ç®¡ç†</text>
    </view>

    <!-- æŠ½å±‰å†…å®¹ -->
    <scroll-view class="drawer-content" scroll-y>
      <!-- å½•éŸ³æ–‡ä»¶ï¼ˆå…¨éƒ¨ï¼‰ -->
      <view class="drawer-item all-files">
        <view class="item-left">
          <image class="folder-icon" src="/assets/icons/folder.png" mode="aspectFit"></image>
          <text class="item-name">å½•éŸ³æ–‡ä»¶</text>
          <text class="item-count">({{totalCount}})</text>
        </view>
      </view>

      <!-- æˆ‘åˆ›å»ºçš„åˆ†ç»„ -->
      <view class="drawer-section">
        <view class="section-header">
          <text class="section-title">æˆ‘åˆ›å»ºçš„</text>
          <view class="section-actions">
            <image class="action-icon" src="/assets/icons/add-folder.png" mode="aspectFit"></image>
            <image class="action-icon" src="/assets/icons/sort.png" mode="aspectFit"></image>
          </view>
        </view>

        <!-- æ–‡ä»¶å¤¹åˆ—è¡¨ -->
        <view 
          class="drawer-item folder-item"
          wx:for="{{folders}}"
          wx:key="id"
          bindtap="selectFolder"
          data-id="{{item.id}}"
        >
          <view class="item-left">
            <image class="folder-icon" src="/assets/icons/folder.png" mode="aspectFit"></image>
            <text class="item-name">{{item.name}}</text>
            <text class="item-count">({{item.count}})</text>
          </view>
          <text class="more-icon">â‹¯</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- ä¸Šä¼ æ“ä½œé€‰æ‹© ActionSheet -->
  <view class="action-sheet-mask" wx:if="{{showUploadSheet}}" bindtap="hideUploadSheet" catchtouchmove="preventDefault"></view>
  <view class="action-sheet upload-sheet {{showUploadSheet ? 'show' : ''}}">
    <view class="action-sheet-header">
      <text class="action-sheet-title">é€‰æ‹©æ“ä½œ</text>
      <view class="action-sheet-close" bindtap="hideUploadSheet">âœ•</view>
    </view>
    <view class="action-sheet-body">
      <view class="action-item upload-action" bindtap="handleUploadFile">
        <text class="action-icon">ğŸ“</text>
        <text class="action-label">ä¸Šä¼ æ–‡ä»¶</text>
      </view>
      <view class="action-item create-action" bindtap="handleCreateFolder">
        <text class="action-icon">â•</text>
        <text class="action-label">æ–°å»ºçŸ¥è¯†åº“</text>
      </view>
    </view>
  </view>

  <!-- çŸ¥è¯†åº“é€‰æ‹© Modal -->
  <view class="modal-mask" wx:if="{{showFolderSelector}}" bindtap="hideFolderSelector" catchtouchmove="preventDefault"></view>
  <view class="modal folder-selector {{showFolderSelector ? 'show' : ''}}" catchtap="preventClose">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©çŸ¥è¯†åº“</text>
    </view>
    <view class="modal-body">
      <text class="current-folder-label">å½“å‰çŸ¥è¯†åº“ï¼š{{currentFolderName}}</text>

      <scroll-view class="folder-list" scroll-y>
        <!-- å½•éŸ³æ–‡ä»¶ï¼ˆå…¨éƒ¨ï¼‰ -->
        <view class="folder-option {{currentFolderId === null ? 'selected' : ''}}"
              bindtap="selectFolderForUpload" data-id="{{null}}" data-name="å½•éŸ³æ–‡ä»¶">
          <text class="folder-name">å½•éŸ³æ–‡ä»¶</text>
          <text class="check-icon" wx:if="{{currentFolderId === null}}">âœ“</text>
        </view>

        <!-- ç”¨æˆ·åˆ›å»ºçš„çŸ¥è¯†åº“ -->
        <view class="folder-option {{currentFolderId === item.id ? 'selected' : ''}}"
              wx:for="{{folders}}" wx:key="id"
              bindtap="selectFolderForUpload" data-id="{{item.id}}" data-name="{{item.name}}">
          <text class="folder-name">{{item.name}}</text>
          <text class="check-icon" wx:if="{{currentFolderId === item.id}}">âœ“</text>
        </view>
      </scroll-view>

      <view class="modal-actions">
        <view class="btn-secondary" bindtap="handleCreateFolderFromSelector">æ–°å»ºçŸ¥è¯†åº“</view>
        <view class="btn-primary" bindtap="confirmFolderSelection">ç¡®è®¤</view>
      </view>
    </view>
  </view>

  <!-- æ–°å»ºçŸ¥è¯†åº“ Modal -->
  <view class="modal-mask" wx:if="{{showCreateFolder}}" catchtap="hideCreateFolder" catchtouchmove="preventDefault"></view>
  <view class="modal small {{showCreateFolder ? 'show' : ''}}" catchtap="preventClose">
    <view class="modal-header">
      <text class="modal-title">æ–°å»ºçŸ¥è¯†åº“</text>
    </view>
    <view class="modal-body">
      <input class="folder-name-input"
             placeholder="è¯·è¾“å…¥çŸ¥è¯†åº“åç§°"
             value="{{newFolderName}}"
             bindinput="onFolderNameInput"
             maxlength="20"
             focus="{{showCreateFolder}}" />
    </view>
    <view class="modal-footer">
      <view class="btn-secondary" bindtap="hideCreateFolder">å–æ¶ˆ</view>
      <view class="btn-primary" bindtap="confirmCreateFolder">ç¡®è®¤</view>
    </view>
  </view>
</view>
