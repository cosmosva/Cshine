# 📝 后端更新协议使用说明

> 快速上手 `BACKEND_UPDATE_PROTOCOL.md`

---

## 🎯 这是什么？

这是一个**标准化的后端更新协议**，定义了每次开发完新功能后，如何通知和执行线上部署。

**核心思想**：
- 开发完功能 → 写一份更新文档 → 线上可以根据文档部署
- 更新不是强制的，但每次都提供清晰的部署方案
- 保证安全、可回滚、有记录

---

## 📚 快速开始

### 作为开发人员

#### 步骤 1：完成功能开发
```bash
# 正常开发和测试
# ...
```

#### 步骤 2：创建更新文档

```bash
# 使用模板创建更新文档
cd Cshine
cp docs/templates/DEPLOY_TEMPLATE.md DEPLOY_<功能名>_$(date +%Y%m%d).md
```

#### 步骤 3：填写更新文档

参考 `BACKEND_UPDATE_PROTOCOL.md` 中的模板，填写：
- ✅ 更新内容说明
- ✅ 涉及的文件变更
- ✅ 数据库变更（如有）
- ✅ 新增依赖（如有）
- ✅ 环境变量（如有）
- ✅ 部署步骤
- ✅ 验证步骤
- ✅ 回滚方案

#### 步骤 4：提交代码

```bash
git add .
git commit -m "feat: 新功能 + 线上部署方案"
git push origin main
```

#### 步骤 5：通知（可选）

在团队群或项目 README 中说明：
> 📢 新功能已开发完成，线上部署方案见：`DEPLOY_xxx_20251109.md`

---

### 作为部署人员

#### 步骤 1：查看更新文档

找到最新的 `DEPLOY_xxx.md` 文件，查看：
- 更新类型（新功能/Bug修复/优化）
- 是否必须更新
- 预计停机时间

#### 步骤 2：评估更新时机

- 必须更新 → 尽快安排
- 建议更新 → 1-3 天内
- 可选更新 → 下次集中更新

#### 步骤 3：执行部署

按照文档中的步骤操作，推荐使用自动脚本：

```bash
ssh root@server_ip
cd /path/to/Cshine
bash UPDATE_SERVER.sh
```

#### 步骤 4：验证和记录

- 完成所有验证步骤
- 在文档中填写"更新记录"部分
- 保留备份至少 7 天

---

## 📂 文件组织

```
Cshine/
├── BACKEND_UPDATE_PROTOCOL.md     # 协议文档（不删除）
├── DEPLOY_LOGIN_20251109.md       # 具体更新文档（定期清理）
├── DEPLOY_MEETING_20251110.md     # 具体更新文档
└── DEPLOY_AUTH_FIX_20251111.md    # 具体更新文档
```

**清理规则**：
- 更新文档保留 **3 个月**
- 3 个月后移动到 `archive/` 目录
- 协议文档永久保留

---

## 🎨 更新文档模板快速参考

```markdown
# 🚀 [功能名称] 线上部署方案

> **更新类型**: 新功能 / Bug修复 / 性能优化 / 安全补丁
> **更新日期**: 2025-11-09
> **是否必须**: 必须 / 建议 / 可选
> **预计停机时间**: 无 / <5分钟 / <15分钟

## 📋 更新内容
[简要描述]

## ⚠️ 更新前检查
- [ ] 代码已提交
- [ ] 本地测试通过
- [ ] 数据库备份完成

## 🚀 部署步骤
方式 1：自动脚本（推荐）
方式 2：手动更新

## ✅ 更新后验证
[验证步骤]

## 🔙 回滚方案
[回滚步骤]
```

---

## 💡 实际示例

### 示例 1：新功能上线

**场景**：开发完成了"会议纪要"功能

**创建文档**：`DEPLOY_MEETING_FEATURE_20251109.md`

```markdown
# 🚀 会议纪要功能 线上部署方案

> **更新类型**: 新功能
> **是否必须**: 建议
> **预计停机时间**: 无

## 📋 更新内容
新增会议纪要功能，包含：
- 上传会议音频
- AI 自动转写
- 智能摘要生成

## 🚀 快速部署
```bash
ssh root@server_ip
cd Cshine
bash UPDATE_SERVER.sh
```

## ✅ 验证
测试会议上传和列表接口
```

---

### 示例 2：紧急 Bug 修复

**场景**：发现登录接口有严重 Bug

**创建文档**：`DEPLOY_AUTH_FIX_20251109.md`

```markdown
# 🚀 登录接口 Bug 修复 线上部署方案

> **更新类型**: Bug修复
> **是否必须**: 必须 🔴
> **预计停机时间**: <5分钟

## 📋 更新内容
修复 `/api/v1/auth/me` 接口认证失败问题

## 🚀 快速部署
```bash
# 立即执行
ssh root@server_ip
cd Cshine
bash UPDATE_SERVER.sh
```

## ✅ 验证
```bash
curl -H "Authorization: Bearer <token>" \
  https://cshine.xuyucloud.com/api/v1/auth/me
```
```

---

## 🔔 更新通知模板

### 微信群通知

```
📢 【后端更新通知】

功能：会议纪要功能上线
类型：新功能
紧急度：建议更新
文档：DEPLOY_MEETING_FEATURE_20251109.md

可以在方便的时候更新线上环境 ✨
```

### GitHub Issue

```markdown
## 🚀 线上部署需求

**功能**：会议纪要功能
**类型**：新功能
**优先级**：中
**部署文档**：[DEPLOY_MEETING_FEATURE_20251109.md](./DEPLOY_MEETING_FEATURE_20251109.md)

### 部署清单
- [ ] 备份数据库
- [ ] 拉取最新代码
- [ ] 重启服务
- [ ] 功能验证

### 预计时间
3-5 分钟

### 建议部署窗口
周一凌晨 2:00-4:00
```

---

## 🎯 核心原则总结

1. **每次功能更新都写文档** → 形成习惯
2. **文档和代码一起提交** → 保持同步
3. **更新不是强制的** → 灵活决策
4. **提供清晰的步骤** → 降低风险
5. **记录更新结果** → 可追溯

---

## 📖 完整文档

详细内容请查看：[BACKEND_UPDATE_PROTOCOL.md](./BACKEND_UPDATE_PROTOCOL.md)

---

**Let Your Ideas Shine. ✨**

