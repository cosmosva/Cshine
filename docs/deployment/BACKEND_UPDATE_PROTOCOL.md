# 后端功能更新标准协议

> **版本**: v1.0  
> **创建日期**: 2025-11-09  
> **适用范围**: Cshine 后端所有功能更新

---

## 📋 协议说明

本协议定义了 Cshine 后端功能更新的标准流程，确保每次开发端完成功能开发后，线上环境能够平滑、安全地更新。

**核心原则**：
- ✅ 每次开发完成后，提供线上更新方案
- ✅ 更新是建议性的，非强制性
- ✅ 提供清晰的更新步骤和验证方法
- ✅ 包含回滚方案，确保安全性

---

## 🔄 更新流程总览

```
┌─────────────────┐
│  开发端完成功能  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  编写更新文档    │ ← 本协议规定的内容
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  提交代码到仓库  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  通知需要更新    │ ← 可选，非强制
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  执行线上部署    │ ← 根据更新文档执行
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  验证功能正常    │
└─────────────────┘
```

---

## 📝 更新文档标准模板

每次功能更新后，需在项目根目录创建一个更新文档，命名格式：

```
DEPLOY_<功能名称>_<日期>.md
例如：DEPLOY_LOGIN_UPDATE_20251109.md
```

### 模板内容

```markdown
# 🚀 [功能名称] 线上部署方案

> **更新类型**: [新功能 / Bug修复 / 性能优化 / 安全补丁]  
> **更新日期**: YYYY-MM-DD  
> **是否必须**: [必须 / 建议 / 可选]  
> **预计停机时间**: [无 / <5分钟 / <15分钟]

---

## 📋 更新内容

### 1. 功能说明
简要描述本次更新的功能或改进。

### 2. 涉及文件
列出所有修改的文件：
- `backend/app/api/xxx.py` - [改动说明]
- `backend/app/models.py` - [改动说明]
- ...

### 3. 数据库变更
- [ ] 无数据库变更
- [ ] 新增表：[表名]
- [ ] 新增字段：[表名.字段名]
- [ ] 修改字段：[表名.字段名]
- [ ] 需要数据迁移

### 4. 依赖变更
- [ ] 无新增依赖
- [ ] 新增依赖：列出 requirements.txt 中新增的包

### 5. 环境变量变更
- [ ] 无新增环境变量
- [ ] 新增配置：列出 .env 中新增的配置项

---

## ⚠️ 更新前检查

### 必须检查项
- [ ] 代码已提交到 main 分支
- [ ] 本地测试通过
- [ ] 数据库备份已完成
- [ ] 了解回滚步骤

### 建议检查项
- [ ] 在低峰期执行更新（如凌晨 2-4 点）
- [ ] 通知相关人员更新计划
- [ ] 准备好监控工具

---

## 🚀 部署步骤

### 方式 1：使用自动脚本（推荐）

```bash
# SSH 登录服务器
ssh root@your_server_ip

# 切换到项目目录
cd /path/to/Cshine/backend

# 运行更新脚本
bash ../UPDATE_SERVER.sh

# 查看服务状态
sudo systemctl status cshine-api
```

**预计用时**: 2-5 分钟

---

### 方式 2：手动更新（适用于特殊情况）

#### 步骤 1：备份数据库
```bash
cd /path/to/Cshine/backend
cp cshine.db cshine.db.backup.$(date +%Y%m%d_%H%M%S)
# 或备份 PostgreSQL
# pg_dump cshine > backup.sql
```

#### 步骤 2：拉取最新代码
```bash
git fetch origin
git pull origin main
```

#### 步骤 3：更新依赖（如有）
```bash
source venv/bin/activate
pip install -r requirements.txt
```

#### 步骤 4：执行数据库迁移（如有）
```bash
# 如果有迁移脚本
python migrations/migrate_xxx.py
```

#### 步骤 5：更新环境变量（如有）
```bash
# 编辑 .env 文件
nano .env
# 添加新的配置项
```

#### 步骤 6：重启服务
```bash
# 使用 systemd
sudo systemctl restart cshine-api

# 或手动重启
pkill -f "python main.py"
nohup python main.py > backend_output.log 2>&1 &
```

#### 步骤 7：验证服务
```bash
# 检查健康状态
curl https://cshine.xuyucloud.com/health

# 查看日志
tail -f logs/cshine.log
```

---

## ✅ 更新后验证

### 1. 服务状态检查
```bash
# 检查进程
ps aux | grep python

# 检查端口
netstat -tlnp | grep 8000

# 检查服务状态
sudo systemctl status cshine-api
```

### 2. API 功能测试
- [ ] 健康检查：`GET /health`
- [ ] 登录接口：`POST /api/v1/auth/login`
- [ ] 新增功能接口：[具体接口]

### 3. 日志检查
```bash
# 查看最近 50 行日志
tail -50 logs/cshine.log

# 实时监控日志
tail -f logs/cshine.log
```

### 4. 业务功能验证
- [ ] 小程序能否正常登录
- [ ] 新功能是否正常工作
- [ ] 旧功能是否受影响

---

## 🔙 回滚方案

### 快速回滚步骤

#### 1. 停止服务
```bash
sudo systemctl stop cshine-api
```

#### 2. 恢复代码
```bash
cd /path/to/Cshine
git log --oneline -10  # 查看最近提交
git reset --hard <上一个版本的commit-hash>
```

#### 3. 恢复数据库（如果修改了）
```bash
cd backend
cp cshine.db.backup.20251109_020000 cshine.db
# 或恢复 PostgreSQL
# psql cshine < backup.sql
```

#### 4. 重启服务
```bash
sudo systemctl start cshine-api
```

#### 5. 验证回滚
```bash
curl https://cshine.xuyucloud.com/health
```

---

## 📊 更新记录

| 步骤 | 状态 | 完成时间 | 备注 |
|------|------|---------|------|
| 备份数据库 | ⏳ | - | - |
| 拉取代码 | ⏳ | - | - |
| 更新依赖 | ⏳ | - | - |
| 数据库迁移 | ⏳ | - | - |
| 重启服务 | ⏳ | - | - |
| 功能验证 | ⏳ | - | - |

---

## 📞 问题处理

### 常见问题

**Q1: 更新后服务无法启动？**
- 检查日志：`tail -f logs/cshine.log`
- 检查端口占用：`netstat -tlnp | grep 8000`
- 立即执行回滚方案

**Q2: 数据库迁移失败？**
- 不要重启服务
- 恢复数据库备份
- 检查迁移脚本
- 联系开发人员

**Q3: 新功能不工作但旧功能正常？**
- 检查环境变量是否配置
- 检查依赖是否安装完整
- 查看 API 文档确认调用方式

---

## 🔗 相关文档

- [完整部署指南](DEPLOYMENT_GUIDE.md)
- [后端 API 文档](backend/README.md)
- [快速参考](backend/QUICKREF.md)
- [故障排查](backend/TROUBLESHOOTING.md)

---

**更新负责人**: [填写姓名]  
**更新执行时间**: [填写时间]  
**更新结果**: [成功 / 失败 / 已回滚]

```

---

## 🎯 使用指南

### 开发人员职责

1. **完成功能开发后**：
   ```bash
   # 1. 根据模板创建更新文档
   cp BACKEND_UPDATE_PROTOCOL.md DEPLOY_新功能_$(date +%Y%m%d).md
   
   # 2. 填写具体内容（见模板）
   
   # 3. 提交代码和文档
   git add .
   git commit -m "feat: 新功能 + 线上部署方案"
   git push origin main
   ```

2. **通知需要更新**（可选）：
   - 在团队群发送更新通知
   - 说明更新类型和重要性
   - 提供文档链接

3. **协助部署**（如果需要）：
   - 解答部署过程中的问题
   - 协助验证功能
   - 处理突发问题

---

### 部署人员职责

1. **评估更新必要性**：
   - 查看更新文档的"是否必须"字段
   - 评估更新风险和收益
   - 决定更新时间

2. **执行部署**：
   - 按照文档步骤操作
   - 记录每个步骤的结果
   - 遇到问题及时停止

3. **验证和反馈**：
   - 完成所有验证步骤
   - 在文档中填写更新记录
   - 反馈更新结果

---

## 📌 更新分类

### 必须更新（Critical）
- 🔴 **安全漏洞修复**
- 🔴 **严重 Bug 修复**
- 🔴 **数据丢失风险修复**

**建议更新时间**：发现后立即更新

---

### 建议更新（Recommended）
- 🟡 **新功能上线**
- 🟡 **性能优化**
- 🟡 **用户体验改进**

**建议更新时间**：1-3 天内更新

---

### 可选更新（Optional）
- 🟢 **代码重构**
- 🟢 **日志优化**
- 🟢 **文档更新**

**建议更新时间**：可以等到下次集中更新

---

## 🔄 更新频率建议

### 理想情况
- **小更新**：每周 1 次（周日晚或周一凌晨）
- **大更新**：每月 1 次
- **紧急更新**：随时（但需要特别谨慎）

### 更新窗口
- **首选**：周一至周四 凌晨 2:00-4:00（用户少）
- **可选**：周日晚上 23:00-01:00
- **避免**：周五、周六、节假日前

---

## 📋 更新检查清单（Checklist）

### 更新前（Pre-Deployment）
```
[ ] 代码已提交并推送到 main 分支
[ ] 创建了更新文档（DEPLOY_xxx.md）
[ ] 文档中所有必填项已完成
[ ] 在开发环境测试通过
[ ] 已备份生产数据库
[ ] 已通知相关人员
[ ] 了解回滚步骤
[ ] 选择了合适的更新时间窗口
```

### 更新中（During Deployment）
```
[ ] 停止服务前检查当前连接数
[ ] 按照文档步骤逐步执行
[ ] 记录每个步骤的执行时间
[ ] 遇到错误立即记录日志
[ ] 不确定时不要继续，先咨询
```

### 更新后（Post-Deployment）
```
[ ] 服务成功启动
[ ] 健康检查通过
[ ] 所有 API 接口正常
[ ] 新功能验证通过
[ ] 旧功能未受影响
[ ] 日志无异常错误
[ ] 小程序端测试通过
[ ] 更新文档中填写了更新记录
[ ] 保留备份至少 7 天
```

---

## 🛡️ 安全准则

1. **永远先备份**
   - 数据库备份是必须的
   - 代码可以回滚，数据丢失难恢复

2. **小步快跑**
   - 频繁的小更新比大规模更新安全
   - 问题容易定位和修复

3. **可回滚性**
   - 确保每次更新都能快速回滚
   - 数据库变更要特别谨慎

4. **监控和日志**
   - 更新后持续监控 15-30 分钟
   - 关注错误日志和性能指标

5. **测试充分**
   - 开发环境完整测试
   - 有条件时在预发布环境测试

---

## 📚 附录：更新文档示例

### 示例 1：新功能更新

**文件名**: `DEPLOY_MEETING_FEATURE_20251109.md`

```markdown
# 🚀 会议纪要功能 线上部署方案

> **更新类型**: 新功能  
> **更新日期**: 2025-11-09  
> **是否必须**: 建议  
> **预计停机时间**: 无

## 📋 更新内容

### 1. 功能说明
新增会议纪要功能，支持上传会议音频、AI 转写、智能摘要。

### 2. 涉及文件
- `backend/app/api/meeting.py` - 新增会议相关 API
- `backend/app/models.py` - 新增 Meeting 表
- `backend/requirements.txt` - 无变更

### 3. 数据库变更
- [x] 新增表：meetings
- [x] 需要数据迁移：否

### 4. 依赖变更
- [x] 无新增依赖

### 5. 环境变量变更
- [x] 无新增环境变量

## 🚀 部署步骤

推荐使用自动脚本：
```bash
ssh root@server_ip
cd Cshine
bash UPDATE_SERVER.sh
```

## ✅ 验证步骤
- 测试会议上传接口
- 测试会议列表接口
- 小程序端测试上传功能
```

---

### 示例 2：Bug 修复

**文件名**: `DEPLOY_AUTH_FIX_20251109.md`

```markdown
# 🚀 登录接口 Bug 修复 线上部署方案

> **更新类型**: Bug修复  
> **更新日期**: 2025-11-09  
> **是否必须**: 必须  
> **预计停机时间**: <5分钟

## 📋 更新内容

### 1. 功能说明
修复 /api/v1/auth/me 接口认证失败的问题。

### 2. 涉及文件
- `backend/app/api/auth.py` - 修复依赖注入错误

### 3-5. 无其他变更

## 🚀 部署步骤
使用自动脚本，预计 3 分钟完成。

## ✅ 验证步骤
```bash
# 测试获取用户信息接口
curl -H "Authorization: Bearer <token>" \
  https://cshine.xuyucloud.com/api/v1/auth/me
```
```

---

## 🎓 最佳实践总结

1. ✅ **每次功能完成都写更新文档**
2. ✅ **更新文档和代码一起提交**
3. ✅ **清晰标注更新的必要性**
4. ✅ **提供详细的回滚方案**
5. ✅ **更新后填写执行记录**
6. ✅ **保留更新文档至少 3 个月**
7. ✅ **定期回顾和改进更新流程**

---

## 🔗 相关资源

- **自动更新脚本**: `UPDATE_SERVER.sh`
- **诊断工具**: `DEBUG_LOGIN.sh`
- **快速参考**: `backend/QUICKREF.md`
- **完整部署指南**: `DEPLOYMENT_GUIDE.md`

---

**协议版本**: v1.0  
**维护团队**: Cshine Dev Team  
**最后更新**: 2025-11-09

---

**Let Your Ideas Shine. ✨**

