<!--ä¼šè®®çºªè¦è¯¦æƒ…é¡µ-->
<wxs module="utils" src="./detail.wxs"></wxs>

<view class="meeting-detail-page">
  <!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
  <navigation-bar title="ä¼šè®®è¯¦æƒ…" back="{{true}}" />

  <!-- åŠ è½½ä¸­ -->
  <view class="loading-state" wx:if="{{loading}}">
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- ä¸»å†…å®¹ -->
  <view class="page-content" wx:if="{{!loading && meeting}}">
    <!-- éŸ³é¢‘æ’­æ”¾å™¨ -->
    <view class="audio-player-container" wx:if="{{meeting.audio_url}}">
      <view class="audio-player">
        <view class="play-btn" bindtap="toggleAudio">
          <text class="icon">{{isPlaying ? 'â¸ï¸' : 'â–¶ï¸'}}</text>
        </view>
        <view class="audio-info">
          <view class="audio-progress">
            <view class="progress-bar">
              <view class="progress-fill" style="width: {{(currentTime / duration) * 100}}%;"></view>
            </view>
          </view>
          <view class="audio-time">
            <text>{{utils.formatDuration(currentTime)}}</text>
            <text>{{utils.formatDuration(duration || meeting.audio_duration)}}</text>
          </view>
        </view>
      </view>
      
      <!-- çŠ¶æ€æŒ‰é’®åŒºåŸŸ -->
      <view class="status-actions">
        <!-- ç«‹å³ç”ŸæˆæŒ‰é’®ï¼ˆpending çŠ¶æ€ï¼‰ -->
        <view class="generate-btn" wx:if="{{meeting.status === 'pending'}}" bindtap="startProcessing">
          <text class="btn-icon">âœ¨</text>
          <text class="btn-text">ç«‹å³ç”Ÿæˆ</text>
        </view>
        
        <!-- å¤„ç†ä¸­æç¤ºï¼ˆprocessing çŠ¶æ€ï¼‰ -->
        <view class="processing-tip" wx:if="{{meeting.status === 'processing'}}">
          <text class="tip-icon">â³</text>
          <text class="tip-text">AI å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</text>
        </view>
        
        <!-- é‡æ–°ç”ŸæˆæŒ‰é’®ï¼ˆcompleted/failed çŠ¶æ€ï¼‰v0.9.9 -->
        <view class="reprocess-btn" wx:if="{{meeting.status === 'completed' || meeting.status === 'failed'}}" bindtap="reprocessMeeting">
          <text class="btn-icon">âœ¨</text>
          <text class="btn-text">é‡æ–°ç”Ÿæˆ</text>
        </view>
      </view>
    </view>

    <!-- Tab å¯¼èˆª -->
    <view class="tab-nav">
      <view 
        class="tab-item {{activeTab === item.id ? 'active' : ''}}"
        wx:for="{{tabs}}"
        wx:key="id"
        data-tab="{{item.id}}"
        bindtap="switchTab"
      >
        {{item.name}}
      </view>
    </view>

    <!-- Tab å†…å®¹ -->
    <scroll-view class="tab-content" scroll-y enhanced show-scrollbar="{{false}}">
      <!-- æ€»ç»“ Tab -->
      <view class="content-section" wx:if="{{activeTab === 'summary'}}">
        <!-- æ®µè½æ‘˜è¦ -->
        <view class="section-card" wx:if="{{meeting.summary}}">
          <view class="card-title">ğŸ“ ä¼šè®®æ‘˜è¦</view>
          <view class="summary-text">{{meeting.summary}}</view>
        </view>
        
        <!-- å‘è¨€æ€»ç»“ -->
        <view class="section-card" wx:if="{{meeting.conversational_summary}}">
          <view class="card-title">ğŸ’¬ å‘è¨€æ€»ç»“</view>
          <view class="summary-text">{{meeting.conversational_summary}}</view>
        </view>
        
        <!-- ç©ºçŠ¶æ€ -->
        <view class="empty-tip" wx:if="{{!meeting.summary && !meeting.conversational_summary}}">
          æš‚æ— æ€»ç»“ä¿¡æ¯
        </view>
      </view>

      <!-- è½¬å½• Tabï¼ˆæ—¶é—´è½´å¼ï¼‰ -->
      <view class="content-section" wx:if="{{activeTab === 'transcript'}}">
        <view class="transcript-timeline" wx:if="{{meeting.transcript_paragraphs && meeting.transcript_paragraphs.length > 0}}">
          <view 
            class="transcript-item" 
            wx:for="{{meeting.transcript_paragraphs}}" 
            wx:key="index"
          >
            <!-- è¯´è¯äººå’Œæ—¶é—´ -->
            <view class="transcript-header">
              <text 
                class="speaker-name-text" 
                data-speaker="SPEAKER_{{item.SpeakerId}}"
                bindtap="showSpeakerAnnotation"
              >
                {{utils.getSpeakerName('SPEAKER_' + item.SpeakerId, speakerMap)}}
              </text>
              <text class="timestamp-text" wx:if="{{item.Words && item.Words.length > 0}}">{{utils.formatDuration(item.Words[0].Start / 1000)}}</text>
            </view>
            
            <!-- å‘è¨€å†…å®¹ -->
            <view class="transcript-content">
              <text wx:for="{{item.Words}}" wx:for-item="word" wx:key="index">{{word.Text}}</text>
            </view>
          </view>
        </view>
        
        <!-- å…œåº•ï¼šæ˜¾ç¤ºåŸå§‹è½¬å½•æ–‡æœ¬ -->
        <view class="section-card" wx:elif="{{meeting.transcript}}">
          <view class="card-title">ğŸ“„ ä¼šè®®è½¬å½•</view>
          <view class="transcript-text">{{meeting.transcript}}</view>
        </view>
        
        <!-- ç©ºçŠ¶æ€ -->
        <view class="empty-tip" wx:else>
          æš‚æ— è½¬å½•ä¿¡æ¯
        </view>
      </view>

      <!-- æ€ç»´å¯¼å›¾ Tab -->
      <view class="content-section" wx:if="{{activeTab === 'mindmap'}}">
        <mindmap data="{{meeting.mind_map}}" wx:if="{{meeting.mind_map}}"></mindmap>
        
        <!-- ç©ºçŠ¶æ€ -->
        <view class="empty-tip" wx:else>
          æš‚æ— æ€ç»´å¯¼å›¾
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- è¯´è¯äººæ ‡æ³¨å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showSpeakerModal}}" bindtap="closeSpeakerModal">
    <view class="modal-content" catchtap="doNothing">
      <view class="modal-header">
        <text class="modal-title">æ ‡æ³¨è¯´è¯äºº</text>
        <view class="modal-close" bindtap="closeSpeakerModal">âœ•</view>
      </view>
      
      <view class="modal-body">
        <text class="modal-subtitle">é€‰æ‹©è”ç³»äºº</text>
        
        <scroll-view class="contacts-list" scroll-y>
          <view 
            class="contact-item" 
            wx:for="{{contacts}}" 
            wx:key="id"
            data-contact-id="{{item.id}}"
            bindtap="selectContact"
          >
            <view class="contact-avatar">
              <text class="avatar-text">{{item.name.substring(0, 1)}}</text>
            </view>
            <view class="contact-info">
              <text class="contact-name">{{item.name}}</text>
              <text class="contact-position" wx:if="{{item.position}}">{{item.position}}</text>
            </view>
          </view>
          
          <view class="empty-contacts" wx:if="{{contacts.length === 0}}">
            æš‚æ— è”ç³»äººï¼Œè¯·å…ˆåœ¨"æˆ‘çš„"é¡µé¢æ·»åŠ 
          </view>
        </scroll-view>
        
        <view class="custom-name-btn" bindtap="customNameAnnotation">
          <text class="btn-icon">âœï¸</text>
          <text class="btn-text">è‡ªå®šä¹‰åç§°</text>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- v0.9.5ï¼šAI æ¨¡å‹é€‰æ‹©å™¨ -->
<ai-model-picker
  show="{{showAiModelPicker}}"
  bind:confirm="onAiModelConfirm"
  bind:close="onAiModelCancel"
/>
